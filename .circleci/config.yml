version: 2.1

#############################################################
# The global variables for this pipeline, which will be 
# mostly different on every application.
#############################################################
parameters:
  release-version:
    type: string
    default: 1.1.<< pipeline.number >>
  repo-name:
    type: string
    default: punchout-customer-catalog
  ecr-image-name:
    type: string
    default: reece/punchout-customer-catalog
  env-repo-url:
    type: string
    default: https://github.com/morsco-reece/external-environments.git
  env-dir:
    type: string
    default: external-environments/external-dev
  java-version:
    type: string
    default: "11.0"

#############################################################
# Special CircleCI plugins needed for common operations.
# The same across all applications.
#############################################################
orbs:
  aws-cli: circleci/aws-cli@2.1.0
  aws-ecr: circleci/aws-ecr@6.13.0
  github-cli: circleci/github-cli@2.0.0
  java-services: morsco-reece/java-services@1.2.0
  helm: circleci/helm@1.1.2
  maven: circleci/maven@1.2.0
  node: circleci/node@5.0.2

#############################################################
# Defines what jobs are tiggered based on branch
#############################################################
workflows:
  single-job-lifecycle:
    jobs:
      # # Every branch/PR executes build, test and test coverage
      # - build
      # # We only publish the build to ECR off of main/master
      # - publish_release:
      #     requires:
      #       - build
      #     filters:
      #       branches:
      #         only: master
      # - deploy_to_dev:
      #     requires:
      #       - publish_release
      #     filters:
      #       branches:
      #         only: master
      - sonar-cloud:
          context: SonarCloud
          # requires:
          #   - build

#############################################################
# Defines the steps of each job defined in workflows
#############################################################
jobs:

  # #############################################################
  # # (1) build
  # # a single step for running install, lint, SCA, test, build
  # #############################################################
  # build:
  #   resource_class: large
  #   executor:
  #     name: maven/default
  #     tag: '11.0'
  #   steps:
  #     - checkout
  #     - run:
  #         command: mvn verify

  # #############################################################
  # # (2) publish_release
  # # publishes an image to ECR, in which the only unique aspsect 
  # # of this code block is involing Copy CodeArtifact Token to Workdir
  # #############################################################
  # publish_release:
  #   resource_class: large
  #   executor:
  #     name: maven/default
  #     tag: << pipeline.parameters.java-version >>
  #   environment:
  #     IMAGE_TAG: << pipeline.parameters.release-version >>
  #   steps:
  #     - checkout
  #     - setup_remote_docker:
  #         version: 19.03.13

  #     # Publish new release version to github
  #     - run:
  #         command: |  
  #           echo "export RELEASE_VERSION=<< pipeline.parameters.release-version >>" >> "$BASH_ENV"
  #         name: Determine Image Version
  #     - github-cli/setup:
  #         token: GITHUB_TOKEN
  #         version: 2.4.0
  #     - run:
  #         command: >-
  #           gh release create << pipeline.parameters.release-version >> --generate-notes --target
  #           $CIRCLE_SHA1
  #         name: Create Github Release
  #     - maven/with_cache:
  #         steps:
  #           - run:
  #               command: |
  #                 ./mvnw -DskipTests spring-boot:build-image -Dspring-boot.build-image.imageName=${AWS_ECR_ACCOUNT_URL}/<< pipeline.parameters.ecr-image-name >>:${RELEASE_VERSION} "$@"
  #               name: Build Image
  #               working_directory: ""
  #     - aws-ecr/ecr-login:
  #         account-url: AWS_ECR_ACCOUNT_URL
  #         aws-access-key-id: AWS_ACCESS_KEY_ID
  #         aws-secret-access-key: AWS_SECRET_ACCESS_KEY
  #         region: AWS_REGION
  #     - aws-ecr/push-image:
  #         account-url: AWS_ECR_ACCOUNT_URL
  #         repo: << pipeline.parameters.ecr-image-name >>
  #         tag: $RELEASE_VERSION

  #     # Publish Helm charts to s3
  #     - helm/install-helm-client:
  #         version: v3.3.4
  #     - java-services/helm_add_s3_repo:
  #         chart-repo-name: reece-ecomm
  #         chart-repo-url: s3://reece-ecomm-chart-repo/charts
  #     - java-services/helm_publish:
  #         helm-chart-name: << pipeline.parameters.repo-name >>
  #         helm-chart-org: reece
  #         helm-chart-path: ./charts/<< pipeline.parameters.repo-name >>
  #         helm-chart-repo-name: reece-ecomm
  #         version: RELEASE_VERSION

  # #############################################################
  # # (3) deploy_to_dev
  # # Edits the Chart.yaml in the shared environments repo for this
  # # application, which is going to be the same everywhere.
  # #############################################################
  # deploy_to_dev:
  #   description: >
  #     Deploys the current version into the Dev environment.
  #   docker:
  #     - image: cimg/base:stable
  #   environment:
  #     EMAIL: morsco-support-alerts@dialexa.com
  #     GIT_AUTHOR_NAME: reece-bot
  #     GIT_COMMITTER_NAME: reece-bot
  #   steps:
  #     - checkout
  #     - github-cli/setup:
  #         token: GITHUB_TOKEN
  #         version: 2.3.0
  #     - run:
  #         name: Define release version
  #         command: |
  #           echo "export RELEASE_VERSION=<< pipeline.parameters.release-version >>" >> "$BASH_ENV"
  #     - run:
  #         name: Update Environments Repo
  #         command: |
  #           cd ../
  #           git config --list
  #           git clone << pipeline.parameters.env-repo-url >>
  #           cd << pipeline.parameters.env-dir >>
  #           set +H
  #           sed -i "/<< pipeline.parameters.repo-name >>/!b;n;c\ \ \ \ version: \"$RELEASE_VERSION\"" Chart.yaml
  #           git add .
  #           git commit -m "<< pipeline.parameters.repo-name >> - $RELEASE_VERSION"
  #           git push

  sonar-cloud:
    docker:
      - image: 'circleci/openjdk:11-jdk'
    steps:
      - checkout
      - run:
          name: Analyze on SonarCloud
          command: mvn verify sonar:sonar -Dsonar.projectKey=sanghung4_SonarCloudTestRepo