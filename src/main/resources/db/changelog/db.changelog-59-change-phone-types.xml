<?xml version="1.0" encoding="UTF-8" ?>
<databaseChangeLog
        logicalFilePath="classpath:changelog-59.xml"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">
    <changeSet id="removePhoneTypeIdsFromAccountRequests" author="huy">
        <preConditions onFail="MARK_RAN" onFailMessage="account_requests phone_type_ids already migrated">
            <not>
                <columnExists tableName="account_requests" columnName="phone_type"/>
            </not>
        </preConditions>
        <addColumn tableName="account_requests">
            <column name="phone_type" type="VARCHAR(50)"></column>
        </addColumn>
        <sql>
            update account_requests
            set phone_type = 'MOBILE'
            where phone_type_id = (Select id from phone_types where name = 'MOBILE');
        </sql>
        <sql>
            update account_requests
            set phone_type = 'HOME'
            where phone_type_id = (Select id from phone_types where name = 'HOME');
        </sql>
        <sql>
            update account_requests
            set phone_type = 'OFFICE'
            where phone_type_id = (Select id from phone_types where name = 'OFFICE');
        </sql>
        <dropColumn tableName="account_requests" columnName="phone_type_id"/>
        <rollback>
            <addColumn tableName="account_requests">
                <column name="phone_type_id" type="UUID">
                    <constraints foreignKeyName="fk_phone_type_id" referencedTableName="phone_types" referencedColumnNames="id" />
                </column>
            </addColumn>
            <sql>
                update account_requests ar
                set phone_type_id = (select id from phone_types where name = 'MOBILE')
                where ar.phone_type = 'MOBILE';
            </sql>
            <sql>
                update account_requests ar
                set phone_type_id = (select id from phone_types where name = 'HOME')
                where ar.phone_type = 'HOME';
            </sql>
            <sql>
                update account_requests ar
                set phone_type_id = (select id from phone_types where name = 'OFFICE')
                where ar.phone_type = 'OFFICE';
            </sql>
            <dropColumn tableName="account_requests" columnName="phone_type"></dropColumn>
        </rollback>
    </changeSet>
    <changeSet id="removePhoneTypeIdsFromAccountRequestsAud" author="huy">
        <preConditions onFail="MARK_RAN" onFailMessage="account_requests_aud phone_type_ids already migrated">
            <not>
                <columnExists tableName="account_requests_aud" columnName="phone_type"/>
            </not>
        </preConditions>
        <addColumn tableName="account_requests_aud">
            <column name="phone_type" type="VARCHAR(50)"></column>
        </addColumn>
        <sql>
            update account_requests_aud
            set phone_type = 'MOBILE'
            where phone_type_id = (Select id from phone_types where name = 'MOBILE');
        </sql>
        <sql>
            update account_requests_aud
            set phone_type = 'HOME'
            where phone_type_id = (Select id from phone_types where name = 'HOME');
        </sql>
        <sql>
            update account_requests_aud
            set phone_type = 'OFFICE'
            where phone_type_id = (Select id from phone_types where name = 'OFFICE');
        </sql>
        <dropColumn tableName="account_requests_aud" columnName="phone_type_id"/>
        <rollback>
            <addColumn tableName="account_requests_aud">
                <column name="phone_type_id" type="uuid"/>
            </addColumn>
            <sql>
                update account_requests_aud ara
                set phone_type_id = (select id from phone_types where name = 'MOBILE')
                where ara.phone_type = 'MOBILE';
            </sql>
            <sql>
                update account_requests_aud ara
                set phone_type_id = (select id from phone_types where name = 'HOME')
                where ara.phone_type = 'HOME';
            </sql>
            <sql>
                update account_requests_aud ara
                set phone_type_id = (select id from phone_types where name = 'OFFICE')
                where ara.phone_type = 'OFFICE';
            </sql>
            <dropColumn tableName="account_requests_aud" columnName="phone_type"></dropColumn>
        </rollback>
    </changeSet>

    <changeSet id="removePhoneTypeIdsFromRejectedAccountRequests" author="huy">
        <preConditions onFail="MARK_RAN" onFailMessage="rejected_account_requests phone_type_ids already migrated">
            <not>
                <columnExists tableName="rejected_account_requests" columnName="phone_type"/>
            </not>
        </preConditions>
        <addColumn tableName="rejected_account_requests">
            <column name="phone_type" type="VARCHAR(50)"></column>
        </addColumn>
        <sql>
            update rejected_account_requests
            set phone_type = 'MOBILE'
            where phone_type_id = (Select id from phone_types where name = 'MOBILE');
        </sql>
        <sql>
            update rejected_account_requests
            set phone_type = 'HOME'
            where phone_type_id = (Select id from phone_types where name = 'HOME');
        </sql>
        <sql>
            update rejected_account_requests
            set phone_type = 'OFFICE'
            where phone_type_id = (Select id from phone_types where name = 'OFFICE');
        </sql>
        <dropColumn tableName="rejected_account_requests" columnName="phone_type_id"/>
        <rollback>
            <addColumn tableName="rejected_account_requests">
                <column name="phone_type_id" type="uuid"/>
            </addColumn>
            <sql>
                update rejected_account_requests rar
                set phone_type_id = (select id from phone_types where name = 'MOBILE')
                where rar.phone_type = 'MOBILE';
            </sql>
            <sql>
                update rejected_account_requests rar
                set phone_type_id = (select id from phone_types where name = 'HOME')
                where rar.phone_type = 'HOME';
            </sql>
            <sql>
                update rejected_account_requests rar
                set phone_type_id = (select id from phone_types where name = 'OFFICE')
                where rar.phone_type = 'OFFICE';
            </sql>
            <dropColumn tableName="rejected_account_requests" columnName="phone_type"></dropColumn>
        </rollback>
    </changeSet>

    <changeSet id="removePhoneTypeIdsFromUsers" author="huy">
        <preConditions onFail="MARK_RAN" onFailMessage="users phone_type_ids already migrated">
            <not>
                <columnExists tableName="users" columnName="phone_type"/>
            </not>
        </preConditions>
        <addColumn tableName="users">
            <column name="phone_type" type="VARCHAR(50)"></column>
        </addColumn>
        <sql>
            update users
            set phone_type = 'MOBILE'
            where phone_type_id = (Select id from phone_types where name = 'MOBILE');
        </sql>
        <sql>
            update users
            set phone_type = 'HOME'
            where phone_type_id = (Select id from phone_types where name = 'HOME');
        </sql>
        <sql>
            update users
            set phone_type = 'OFFICE'
            where phone_type_id = (Select id from phone_types where name = 'OFFICE');
        </sql>
        <dropColumn tableName="users" columnName="phone_type_id"/>
        <rollback>
            <addColumn tableName="users">
                <column name="phone_type_id" type="uuid"/>
            </addColumn>
            <sql>
                update users u
                set phone_type_id = (select id from phone_types where name = 'MOBILE')
                where u.phone_type = 'MOBILE';
            </sql>
            <sql>
                update users u
                set phone_type_id = (select id from phone_types where name = 'HOME')
                where u.phone_type = 'HOME';
            </sql>
            <sql>
                update users u
                set phone_type_id = (select id from phone_types where name = 'OFFICE')
                where u.phone_type = 'OFFICE';
            </sql>
            <dropColumn tableName="users" columnName="phone_type"></dropColumn>
        </rollback>
    </changeSet>
    <changeSet id="removePhoneTypeIdsFromUsersAud" author="huy">
        <preConditions onFail="MARK_RAN" onFailMessage="users_aud phone_type_ids already migrated">
            <not>
                <columnExists tableName="users_aud" columnName="phone_type"/>
            </not>
        </preConditions>
        <addColumn tableName="users_aud">
            <column name="phone_type" type="VARCHAR(50)"></column>
        </addColumn>
        <sql>
            update users_aud
            set phone_type = 'MOBILE'
            where phone_type_id = (Select id from phone_types where name = 'MOBILE');
        </sql>
        <sql>
            update users_aud
            set phone_type = 'HOME'
            where phone_type_id = (Select id from phone_types where name = 'HOME');
        </sql>
        <sql>
            update users_aud
            set phone_type = 'OFFICE'
            where phone_type_id = (Select id from phone_types where name = 'OFFICE');
        </sql>
        <dropColumn tableName="users_aud" columnName="phone_type_id"/>
        <rollback>
            <addColumn tableName="users_aud">
                <column name="phone_type_id" type="uuid"/>
            </addColumn>
            <sql>
                update users_aud ua
                set phone_type_id = (select id from phone_types where name = 'MOBILE')
                where ua.phone_type = 'MOBILE';
            </sql>
            <sql>
                update users_aud ua
                set phone_type_id = (select id from phone_types where name = 'HOME')
                where ua.phone_type = 'HOME';
            </sql>
            <sql>
                update users_aud ua
                set phone_type_id = (select id from phone_types where name = 'OFFICE')
                where ua.phone_type = 'OFFICE';
            </sql>
            <dropColumn tableName="users_aud" columnName="phone_type"></dropColumn>
        </rollback>
    </changeSet>
    <changeSet id="removePhoneTypesTable" author="huy">
        <preConditions onFail="MARK_RAN" onFailMessage="phone_types already migrated">
            <tableExists tableName="phone_types"/>
        </preConditions>
        <dropTable tableName="phone_types"></dropTable>
        <rollback>
            <createTable tableName="phone_types">
                <column defaultValueComputed="uuid_generate_v4()" name="id" type="UUID">
                    <constraints nullable="false" primaryKey="true" primaryKeyName="pk_phone_types_id" />
                </column>
                <column name="name" type="VARCHAR(200)"/>
                <column name="display_name" type="VARCHAR(200)" />
            </createTable>
            <insert tableName="phone_types">
                <column name="name" value="MOBILE" />
                <column name="display_name" value="Mobile" />
            </insert>
            <insert tableName="phone_types">
                <column name="name" value="HOME" />
                <column name="display_name" value="Home" />
            </insert>
            <insert tableName="phone_types">
                <column name="name" value="OFFICE" />
                <column name="display_name" value="Office" />
            </insert>
        </rollback>
    </changeSet>
    <changeSet author="huy" id="v58-remove-phone_types_table">
        <tagDatabase tag="v59" />
    </changeSet>
</databaseChangeLog>
