<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog logicalFilePath="classpath:changelog-4.xml" xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">
    <changeSet author="brant.carthel@dialexa.com" id="removeUsersAccountsTable">
        <preConditions onFail="MARK_RAN" onFailMessage="table users_accounts doesn't exist">
            <tableExists tableName="users_accounts"/>
        </preConditions>
        <dropTable tableName="users_accounts"/>
        <rollback>
            <createTable tableName="users_accounts">
                <column name="user_id" type="UUID">
                    <constraints nullable="false" foreignKeyName="fk_user_id" referencedTableName="users" referencedColumnNames="id"/>
                </column>
                <column name="account_id" type="UUID">
                    <constraints nullable="false" foreignKeyName="fk_account_id" referencedTableName="accounts" referencedColumnNames="id"/>
                </column>
            </createTable>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="addUsersBillToAccountsTable">
        <preConditions onFail="MARK_RAN" onFailMessage="table users_billto_accounts already exists">
            <not>
                <tableExists tableName="users_billto_accounts"/>
            </not>
        </preConditions>
        <createTable tableName="users_billto_accounts">
            <column name="user_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_user_id_billto" referencedTableName="users" referencedColumnNames="id"/>
            </column>
            <column name="account_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_account_id_billto" referencedTableName="accounts" referencedColumnNames="id"/>
            </column>
            <column name="is_restricted" type="boolean">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <rollback>
            <dropTable tableName="users_billto_accounts"/>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="addUsersShipToAccountsTable">
        <preConditions onFail="MARK_RAN" onFailMessage="table users_shipto_accounts already exists">
            <not>
                <tableExists tableName="users_shipto_accounts"/>
            </not>
        </preConditions>
        <createTable tableName="users_shipto_accounts">
            <column name="user_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_user_id_shipto" referencedTableName="users" referencedColumnNames="id"/>
            </column>
            <column name="account_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_account_id_shipto" referencedTableName="accounts" referencedColumnNames="id"/>
            </column>
        </createTable>
        <rollback>
            <dropTable tableName="users_shipto_accounts"/>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="renameRootUserIdToOwnerIdAccounts">
        <preConditions onFail="MARK_RAN" onFailMessage="owner_id column on accounts already exists">
            <not>
                <columnExists tableName="accounts" columnName="owner_id"/>
            </not>
        </preConditions>
        <renameColumn tableName="accounts" oldColumnName="root_user_id" newColumnName="owner_id"/>
        <rollback>
            <renameColumn tableName="accounts" oldColumnName="owner_id" newColumnName="root_user_id"/>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="dropColumnErpEntityIdAccounts">
        <preConditions onFail="MARK_RAN" onFailMessage="erp_entity_id does not exist on accounts">
            <columnExists tableName="accounts" columnName="erp_entity_id"/>
        </preConditions>
        <dropColumn tableName="accounts" columnName="erp_entity_id"/>
        <rollback>
            <addColumn tableName="accounts">
                <column name="erp_entity_id" type="VARCHAR(200)">
                    <constraints nullable="false"/>
                </column>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="dropColumnErpSystemAccounts">
        <preConditions onFail="MARK_RAN" onFailMessage="erp_system does not exist on accounts">
            <columnExists tableName="accounts" columnName="erp_system"/>
        </preConditions>
        <dropColumn tableName="accounts" columnName="erp_system"/>
        <rollback>
            <addColumn tableName="accounts">
                <column name="erp_system" type="erp_enum">
                    <constraints nullable="false"/>
                </column>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="addColumnNameAccounts">
        <preConditions onFail="MARK_RAN" onFailMessage="name already exists on accounts">
            <not>
                <columnExists tableName="accounts" columnName="name"/>
            </not>
        </preConditions>
        <addColumn tableName="accounts">
            <column name="name" type="VARCHAR(200)"/>
        </addColumn>
        <rollback>
            <dropColumn tableName="accounts" columnName="name"/>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="dropColumnAccountIdUsers">
        <preConditions onFail="MARK_RAN" onFailMessage="account_id does not exist on users">
            <columnExists tableName="users" columnName="account_id"/>
        </preConditions>
        <dropColumn tableName="users" columnName="account_id"/>
        <rollback>
            <addColumn tableName="users">
                <column name="account_id" type="UUID">
                    <constraints foreignKeyName="fk_users_account_id" referencedTableName="accounts" referencedColumnNames="id"/>
                </column>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="dropColumnErpContactIdUsers">
        <preConditions onFail="MARK_RAN" onFailMessage="erp_contact_id does not exist on users">
            <columnExists tableName="users" columnName="erp_contact_id"/>
        </preConditions>
        <dropColumn tableName="users" columnName="erp_contact_id"/>
        <rollback>
            <addColumn tableName="users">
                <column name="erp_contact_id" type="INT">
                    <constraints nullable="false"/>
                </column>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="dropColumnIsRestrictedUsers">
        <preConditions onFail="MARK_RAN" onFailMessage="is_restricted does not exist on users">
            <columnExists tableName="users" columnName="is_restricted"/>
        </preConditions>
        <dropColumn tableName="users" columnName="is_restricted"/>
        <rollback>
            <addColumn tableName="users">
                <column name="is_restricted" type="boolean" defaultValue="0" afterColumn="id" >
                    <constraints nullable="false"/>
                </column>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="renameUsernameToEmailUsers">
        <preConditions onFail="MARK_RAN" onFailMessage="email column on users already exists">
            <not>
                <columnExists tableName="users" columnName="email"/>
            </not>
        </preConditions>
        <renameColumn tableName="users" oldColumnName="username" newColumnName="email"/>
        <rollback>
            <renameColumn tableName="users" oldColumnName="email" newColumnName="username"/>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="createTableErps">
        <preConditions onFail="MARK_RAN" onFailMessage="table erps already exists">
            <not>
                <tableExists tableName="erps"/>
            </not>
        </preConditions>
        <createTable tableName="erps">
            <column defaultValueComputed="uuid_generate_v4()" name="id" type="UUID">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_erps_id"/>
            </column>
            <column name="name" type="VARCHAR(200)"/>
            <column name="info" type="VARCHAR(200)"/>
        </createTable>
        <rollback>
            <dropTable tableName="erps"/>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="createTableErpsAccounts">
        <preConditions onFail="MARK_RAN" onFailMessage="table erps_accounts already exists">
            <not>
                <tableExists tableName="erps_accounts"/>
            </not>
        </preConditions>
        <createTable tableName="erps_accounts">
            <column name="erp_id" type="UUID">
                <constraints foreignKeyName="fk_erp_id_erp_accounts" referencedTableName="erps" referencedColumnNames="id"/>
            </column>
            <column name="account_id" type="UUID">
                <constraints foreignKeyName="fk_account_id_erp_accounts" referencedTableName="accounts" referencedColumnNames="id"/>
            </column>
            <column name="erp_account_id" type="INT"/>
        </createTable>
        <rollback>
            <dropTable tableName="erps_accounts"/>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="createTableErpsUsers">
        <preConditions onFail="MARK_RAN" onFailMessage="table erps_users already exists">
            <not>
                <tableExists tableName="erps_users"/>
            </not>
        </preConditions>
        <createTable tableName="erps_users">
            <column name="erp_id" type="UUID">
                <constraints foreignKeyName="fk_erp_id_erp_users" referencedTableName="erps" referencedColumnNames="id"/>
            </column>
            <column name="user_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_user_id_erps_users" referencedTableName="users" referencedColumnNames="id"/>
            </column>
            <column name="erp_user_id" type="INT"/>
            <column name="erp_user_login" type="VARCHAR(200)"/>
            <column name="erp_user_password" type="VARCHAR(200)"/>
        </createTable>
        <rollback>
            <dropTable tableName="erps_users"/>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="addColumnIsCompletedAccountRequests">
        <preConditions onFail="MARK_RAN" onFailMessage="column is_completed already exists on account_requests">
            <not>
                <columnExists tableName="account_requests" columnName="is_completed"/>
            </not>
        </preConditions>
        <addColumn tableName="account_requests">
            <column name="is_completed" type="BOOLEAN"/>
        </addColumn>
        <rollback>
            <dropColumn tableName="account_requests" columnName="is_completed"/>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="addEclipseErpSeed">
        <preConditions onFail="MARK_RAN" onFailMessage="ECLIPSE erp already added for tables erps">
            <not>
                <sqlCheck expectedResult="1">
                    SELECT COUNT(1) FROM erps WHERE name = 'ECLIPSE'
                </sqlCheck>
            </not>
        </preConditions>
        <insert tableName="erps">
            <column name="name" value="ECLIPSE"/>
            <column name="info" value="The Eclipse ERP"/>
        </insert>
        <rollback>
            <delete tableName="erps">
                <where>name = "ECLIPSE"</where>
            </delete>
        </rollback>
    </changeSet>
    <changeSet author="brant.carthel@dialexa.com" id="tag-4-erp-account-update">
        <tagDatabase tag="v4"/>
    </changeSet>
</databaseChangeLog>