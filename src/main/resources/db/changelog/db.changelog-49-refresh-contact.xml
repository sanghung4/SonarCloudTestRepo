<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
        logicalFilePath="classpath:changelog-49.xml"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">
    <changeSet id="erpsUsersUniqueConstraint" author="tim@dialexa.com">
        <preConditions onFail="MARK_RAN" onFailMessage="refresh permission already exists">
            <sqlCheck expectedResult="1">
                select count(*) from permissions where name = 'refresh_contact'
            </sqlCheck>
        </preConditions>
        <sql>
            INSERT INTO permissions (id, name) VALUES ('2a2484fc-f046-4008-bb7b-6a16d424f365', 'refresh_contact');
            INSERT INTO role_permissions (role_id, permission_id) VALUES ('69ba59cd-b8b6-4505-9a00-bc5c1832b38f', '2a2484fc-f046-4008-bb7b-6a16d424f365');
        </sql>
        <rollback>
            DELETE FROM role_permissions WHERE permission_id = '2a2484fc-f046-4008-bb7b-6a16d424f365';
            DELETE FROM permissions WHERE id = '2a2484fc-f046-4008-bb7b-6a16d424f365';
        </rollback>
    </changeSet>
    <changeSet id="addAuditColumnsToErpsUsers" author="tim@dialexa.com">
        <preConditions onFail="MARK_RAN" onFailMessage="erps_users audit columns already exist">
            <not>
                <columnExists tableName="erps_users" columnName="created_at" />
                <columnExists tableName="erps_users" columnName="created_by" />
                <columnExists tableName="erps_users" columnName="updated_at" />
                <columnExists tableName="erps_users" columnName="updated_by" />
            </not>
        </preConditions>
        <addColumn tableName="erps_users">
            <column name="created_at" type="TIMESTAMP WITHOUT TIME ZONE" />
            <column name="created_by" type="VARCHAR(255)" />
            <column name="updated_at" type="TIMESTAMP WITHOUT TIME ZONE" />
            <column name="updated_by" type="varchar(255)" />
        </addColumn>
        <!-- Default the columns  -->
        <sql>
            update erps_users set created_at = current_date, created_by = 'REFRESH CONTACT MIGRATION';
        </sql>
        <rollback>
            <dropColumn tableName="erps_users" columnName="created_at" />
            <dropColumn tableName="erps_users" columnName="created_by" />
            <dropColumn tableName="erps_users" columnName="updated_at" />
            <dropColumn tableName="erps_users" columnName="updated_by" />
        </rollback>
    </changeSet>
    <changeSet id="setErpsUsersAuditConstraints" author="tim@dialexa.com">
        <addNotNullConstraint tableName="erps_users" columnName="created_at" />
        <addNotNullConstraint tableName="erps_users" columnName="created_by" />
        <rollback>
            <dropNotNullConstraint tableName="erps_users" columnName="created_at" />
            <dropNotNullConstraint tableName="erps_users" columnName="created_by" />
        </rollback>
    </changeSet>
    <changeSet id="dropUnnecessaryAuditTables" author="tim@dialexa.com">
        <dropForeignKeyConstraint baseTableName="accounts_accounts_aud" constraintName="FKdiuj4ta346lhnkjakc60xcrdi" />
        <dropPrimaryKey tableName="accounts_accounts_aud" constraintName="accounts_accounts_audPK" />
        <dropTable tableName="accounts_accounts_aud" />

        <dropForeignKeyConstraint baseTableName="accounts_aud" constraintName="FKlcp7umwrr7ayllyqt4ouq7sok" />
        <dropPrimaryKey tableName="accounts_aud" constraintName="accounts_audPK" />
        <dropTable tableName="accounts_aud" />

        <dropForeignKeyConstraint baseTableName="erps_accounts_aud" constraintName="FK1dnk2n5qw6fwpjlahy7tlfr5n" />
        <dropTable tableName="erps_accounts_aud" />

        <dropForeignKeyConstraint baseTableName="permissions_aud" constraintName="FKlpar9ugdsdrykmoi89b5c0ed5" />
        <dropTable tableName="permissions_aud" />

        <dropForeignKeyConstraint baseTableName="phone_types_aud" constraintName="FKawf5svpucddpmt2tvlo2ok81i" />
        <dropPrimaryKey tableName="phone_types_aud" constraintName="phone_types_audPK" />
        <dropTable tableName="phone_types_aud" />

        <dropForeignKeyConstraint baseTableName="rejection_reasons_aud" constraintName="FKse036519ea93n63nv0ledbcv4" />
        <dropTable tableName="rejection_reasons_aud" />

        <dropForeignKeyConstraint baseTableName="roles_aud" constraintName="FKgnrs9w0rs282s9qck8u58hvip" />
        <dropPrimaryKey tableName="roles_aud" constraintName="roles_audPK" />
        <dropTable tableName="roles_aud" />

        <dropForeignKeyConstraint baseTableName="users_billto_accounts_aud" constraintName="FKovnfu9ygday4wvk1ndokxgj52" />
        <dropPrimaryKey tableName="users_billto_accounts_aud" constraintName="users_billto_accounts_audPK" />
        <dropTable tableName="users_billto_accounts_aud" />

        <dropTable tableName="users_shipto_accounts" />

        <dropForeignKeyConstraint baseTableName="users_shipto_accounts_aud" constraintName="FK3pccexdy0ptt5wmwe28a0vrdy" />
        <dropPrimaryKey tableName="users_shipto_accounts_aud" constraintName="users_shipto_accounts_audPK" />
        <dropTable tableName="users_shipto_accounts_aud" />

        <dropForeignKeyConstraint baseTableName="role_permissions_aud" constraintName="FKkcc7f9aecfbb6shbtpsgoevri" />
        <dropPrimaryKey tableName="role_permissions_aud" constraintName="role_permissions_audPK" />
        <dropTable tableName="role_permissions_aud" />

        <rollback>
            <createTable tableName="accounts_accounts_aud">
                <column name="rev" type="INT">
                    <constraints nullable="false"/>
                </column>
                <column name="parent_account_id" type="UUID">
                    <constraints nullable="false"/>
                </column>
                <column name="id" type="UUID">
                    <constraints nullable="false"/>
                </column>
                <column name="revtype" type="SMALLINT"/>
            </createTable>
            <addPrimaryKey
                    columnNames="rev, parent_account_id, id"
                    constraintName="accounts_accounts_audPK"
                    tableName="accounts_accounts_aud"/>
            <addForeignKeyConstraint
                    baseColumnNames="rev"
                    baseTableName="accounts_accounts_aud"
                    constraintName="FKdiuj4ta346lhnkjakc60xcrdi"
                    deferrable="false"
                    initiallyDeferred="false"
                    referencedColumnNames="id"
                    referencedTableName="custom_revinfo"/>

            <createTable tableName="accounts_aud">
                <column name="id" type="UUID">
                    <constraints nullable="false"/>
                </column>
                <column name="rev" type="INT">
                    <constraints nullable="false"/>
                </column>
                <column name="revtype" type="SMALLINT"/>
                <column name="name" type="VARCHAR(255)"/>
                <column name="owner_id" type="UUID"/>
                <column name="parent_account_id" type="UUID"/>
            </createTable>
            <addPrimaryKey
                    columnNames="id, rev"
                    constraintName="accounts_audPK"
                    tableName="accounts_aud"/>
            <addForeignKeyConstraint
                    baseColumnNames="rev"
                    baseTableName="accounts_aud"
                    constraintName="FKlcp7umwrr7ayllyqt4ouq7sok"
                    deferrable="false"
                    initiallyDeferred="false"
                    referencedColumnNames="id"
                    referencedTableName="custom_revinfo"/>

            <createTable tableName="erps_accounts_aud">
                <column name="id" type="UUID">
                    <constraints nullable="false"/>
                </column>
                <column name="rev" type="INT">
                    <constraints nullable="false"/>
                </column>
                <column name="revtype" type="SMALLINT"/>
                <column name="erp_account_id" type="INT"/>
                <column name="erp_id" type="UUID"/>
                <column name="account_id" type="UUID"/>
                <column name="is_billto" type="boolean"/>
            </createTable>
            <addPrimaryKey
                    columnNames="id, rev"
                    constraintName="erps_accounts_audPK"
                    tableName="erps_accounts_aud"/>
            <addForeignKeyConstraint
                    baseColumnNames="rev"
                    baseTableName="erps_accounts_aud"
                    constraintName="FK1dnk2n5qw6fwpjlahy7tlfr5n"
                    deferrable="false"
                    initiallyDeferred="false"
                    referencedColumnNames="id"
                    referencedTableName="custom_revinfo"/>

            <createTable tableName="permissions_aud">
                <column name="id" type="UUID">
                    <constraints nullable="false"/>
                </column>
                <column name="rev" type="INT">
                    <constraints nullable="false"/>
                </column>
                <column name="revtype" type="SMALLINT"/>
                <column name="name" type="VARCHAR(255)"/>
            </createTable>
            <addPrimaryKey
                    columnNames="id, rev"
                    constraintName="permissions_audPK"
                    tableName="permissions_aud"/>
            <addForeignKeyConstraint
                    baseColumnNames="rev"
                    baseTableName="permissions_aud"
                    constraintName="FKlpar9ugdsdrykmoi89b5c0ed5"
                    deferrable="false"
                    initiallyDeferred="false"
                    referencedColumnNames="id"
                    referencedTableName="custom_revinfo"/>


            <createTable tableName="rejection_reasons_aud">
                <column name="id" type="UUID">
                    <constraints nullable="false"/>
                </column>
                <column name="rev" type="INT">
                    <constraints nullable="false"/>
                </column>
                <column name="revtype" type="SMALLINT"/>
                <column name="description" type="VARCHAR(255)"/>
                <column name="type" type="VARCHAR(255)"/>
            </createTable>
            <addPrimaryKey
                    columnNames="id, rev"
                    constraintName="rejection_reasons_audPK"
                    tableName="rejection_reasons_aud"/>
            <addForeignKeyConstraint
                    baseColumnNames="rev"
                    baseTableName="rejection_reasons_aud"
                    constraintName="FKse036519ea93n63nv0ledbcv4"
                    deferrable="false"
                    initiallyDeferred="false"
                    referencedColumnNames="id"
                    referencedTableName="custom_revinfo"/>

            <createTable tableName="phone_types_aud">
                <column name="id" type="UUID">
                    <constraints nullable="false"/>
                </column>
                <column name="rev" type="INT">
                    <constraints nullable="false"/>
                </column>
                <column name="revtype" type="SMALLINT"/>
                <column name="display_name" type="VARCHAR(255)"/>
                <column name="name" type="VARCHAR(255)"/>
            </createTable>
            <addPrimaryKey
                    columnNames="id, rev"
                    constraintName="phone_types_audPK"
                    tableName="phone_types_aud"/>
            <addForeignKeyConstraint
                    baseColumnNames="rev"
                    baseTableName="phone_types_aud"
                    constraintName="FKawf5svpucddpmt2tvlo2ok81i"
                    deferrable="false"
                    initiallyDeferred="false"
                    referencedColumnNames="id"
                    referencedTableName="custom_revinfo"/>

            <createTable tableName="roles_aud">
                <column name="id" type="UUID">
                    <constraints nullable="false"/>
                </column>
                <column name="rev" type="INT">
                    <constraints nullable="false"/>
                </column>
                <column name="revtype" type="SMALLINT"/>
                <column name="description" type="VARCHAR(255)"/>
                <column name="name" type="VARCHAR(255)"/>
                <column name="is_internal" type="boolean"/>
            </createTable>
            <addPrimaryKey
                    columnNames="id, rev"
                    constraintName="roles_audPK"
                    tableName="roles_aud"/>
            <addForeignKeyConstraint
                    baseColumnNames="rev"
                    baseTableName="roles_aud"
                    constraintName="FKgnrs9w0rs282s9qck8u58hvip"
                    deferrable="false"
                    initiallyDeferred="false"
                    referencedColumnNames="id"
                    referencedTableName="custom_revinfo"/>

            <createTable tableName="users_billto_accounts_aud">
                <column name="account_id" type="UUID">
                    <constraints nullable="false"/>
                </column>
                <column name="user_id" type="UUID">
                    <constraints nullable="false"/>
                </column>
                <column name="rev" type="INT">
                    <constraints nullable="false"/>
                </column>
                <column name="revtype" type="SMALLINT"/>
                <column name="is_restricted" type="BOOLEAN"/>
            </createTable>
            <addPrimaryKey
                    columnNames="rev, account_id, user_id"
                    constraintName="users_billto_accounts_audPK"
                    tableName="users_billto_accounts_aud"/>
            <addForeignKeyConstraint
                    baseColumnNames="rev"
                    baseTableName="users_billto_accounts_aud"
                    constraintName="FKovnfu9ygday4wvk1ndokxgj52"
                    deferrable="false"
                    initiallyDeferred="false"
                    referencedColumnNames="id"
                    referencedTableName="custom_revinfo"/>

            <createTable tableName="users_shipto_accounts">
                <column name="user_id" type="UUID">
                    <constraints nullable="false" foreignKeyName="fk_user_id_shipto" referencedTableName="users" referencedColumnNames="id"/>
                </column>
                <column name="account_id" type="UUID">
                    <constraints nullable="false" foreignKeyName="fk_account_id_shipto" referencedTableName="accounts" referencedColumnNames="id"/>
                </column>
            </createTable>

            <createTable tableName="users_shipto_accounts_aud">
                <column name="account_id" type="UUID">
                    <constraints nullable="false"/>
                </column>
                <column name="user_id" type="UUID">
                    <constraints nullable="false"/>
                </column>
                <column name="rev" type="INT">
                    <constraints nullable="false"/>
                </column>
                <column name="revtype" type="SMALLINT"/>
            </createTable>
            <addPrimaryKey
                    columnNames="account_id, user_id, rev"
                    constraintName="users_shipto_accounts_audPK"
                    tableName="users_shipto_accounts_aud"/>
            <addForeignKeyConstraint
                    baseColumnNames="rev"
                    baseTableName="users_shipto_accounts_aud"
                    constraintName="FK3pccexdy0ptt5wmwe28a0vrdy"
                    deferrable="false"
                    initiallyDeferred="false"
                    referencedColumnNames="id"
                    referencedTableName="custom_revinfo"/>

            <createTable tableName="role_permissions_aud">
                <column name="rev" type="INT">
                    <constraints nullable="false"/>
                </column>
                <column name="role_id" type="UUID">
                    <constraints nullable="false"/>
                </column>
                <column name="permission_id" type="UUID">
                    <constraints nullable="false"/>
                </column>
                <column name="revtype" type="SMALLINT"/>
            </createTable>
            <addPrimaryKey
                    columnNames="rev, role_id, permission_id"
                    constraintName="role_permissions_audPK"
                    tableName="role_permissions_aud"/>
            <addForeignKeyConstraint
                    baseColumnNames="rev"
                    baseTableName="role_permissions_aud"
                    constraintName="FKkcc7f9aecfbb6shbtpsgoevri"
                    deferrable="false"
                    initiallyDeferred="false"
                    referencedColumnNames="id"
                    referencedTableName="custom_revinfo"/>
        </rollback>
    </changeSet>
    <changeSet author="tim@dialexa.com" id="v49-refresh-permissions">
        <tagDatabase tag="v49"/>
    </changeSet>
</databaseChangeLog>
